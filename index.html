<!DOCTYPE html>
<html lang="en">
<head>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#4CAF50">
<script src="pwa-register.js" defer></script>

<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>File Compressor & Merger</title>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#4CAF50">
<style>
  body { font-family: Arial, sans-serif; margin: 20px; }
  .preview-container img { max-width: 100%; margin-top: 10px; }
  input[type=file] { margin-bottom: 10px; }
</style>
</head>
<body>
<h1>File Compressor & Merger</h1>

<input type="file" id="fileInput" multiple accept=".jpg,.jpeg,.png,.pdf">
<button onclick="processFiles()">Process & Download</button>

<div class="preview-container" id="preview"></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.17.1/pdf-lib.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>

<script>
const TARGET_SIZE_KB = 200;
pdfjsLib.GlobalWorkerOptions.workerSrc = "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js";

// Compress an image to target size
async function compressImageToTarget(img, maxKB = TARGET_SIZE_KB) {
  let quality = 0.9;
  let blob;
  do {
    const canvas = document.createElement("canvas");
    canvas.width = img.width;
    canvas.height = img.height;
    const ctx = canvas.getContext("2d");
    ctx.drawImage(img, 0, 0, img.width, img.height);
    const dataUrl = canvas.toDataURL("image/jpeg", quality);
    blob = dataURLtoBlob(dataUrl);
    quality -= 0.05;
  } while (blob.size / 1024 > maxKB && quality > 0.05);
  return blob;
}

// Convert dataURL to Blob
function dataURLtoBlob(dataUrl) {
  const parts = dataUrl.split(","), mime = parts[0].match(/:(.*?);/)[1];
  const bstr = atob(parts[1]);
  let n = bstr.length, u8arr = new Uint8Array(n);
  while (n--) u8arr[n] = bstr.charCodeAt(n);
  return new Blob([u8arr], { type: mime });
}

// Render a PDF page to compressed image blob
async function pdfPageToCompressedBlob(pdfDoc, pageNum, maxKB) {
  const page = await pdfDoc.getPage(pageNum);
  const viewport = page.getViewport({ scale: 1.5 });
  const canvas = document.createElement("canvas");
  const ctx = canvas.getContext("2d");
  canvas.width = viewport.width;
  canvas.height = viewport.height;
  await page.render({ canvasContext: ctx, viewport }).promise;
  const img = new Image();
  img.src = canvas.toDataURL("image/jpeg", 1.0);
  await new Promise(res => img.onload = res);
  return await compressImageToTarget(img, maxKB);
}

// Main processing
async function processFiles() {
  const input = document.getElementById("fileInput");
  const files = Array.from(input.files);
  if (!files.length) return alert("Please select files first.");

  const pdfDoc = await PDFLib.PDFDocument.create();

  for (let file of files) {
    if (file.type === "application/pdf") {
      const arrayBuffer = await file.arrayBuffer();
      const loadedPdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
      for (let i = 1; i <= loadedPdf.numPages; i++) {
        const compressedBlob = await pdfPageToCompressedBlob(loadedPdf, i, TARGET_SIZE_KB);
        const imgBytes = await compressedBlob.arrayBuffer();
        const imgEmbed = await pdfDoc.embedJpg(imgBytes);
        const page = pdfDoc.addPage([imgEmbed.width, imgEmbed.height]);
        page.drawImage(imgEmbed, { x: 0, y: 0, width: imgEmbed.width, height: imgEmbed.height });
      }
    } else if (file.type.startsWith("image/")) {
      const img = new Image();
      img.src = URL.createObjectURL(file);
      await new Promise(res => img.onload = res);
      const compressedBlob = await compressImageToTarget(img, TARGET_SIZE_KB);
      const imgBytes = await compressedBlob.arrayBuffer();
      const imgEmbed = file.type === "image/png" ? await pdfDoc.embedPng(imgBytes) : await pdfDoc.embedJpg(imgBytes);
      const page = pdfDoc.addPage([imgEmbed.width, imgEmbed.height]);
      page.drawImage(imgEmbed, { x: 0, y: 0, width: imgEmbed.width, height: imgEmbed.height });
    }
  }

  const pdfBytes = await pdfDoc.save();
  downloadBlob(new Blob([pdfBytes], { type: "application/pdf" }), "output_compressed.pdf");
}

// Download helper
function downloadBlob(blob, filename) {
  const link = document.createElement("a");
  link.href = URL.createObjectURL(blob);
  link.download = filename;
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
}
</script>
</body>
</html>
